import{r as n,s as C,j as t,y as O,n as E}from"./app-DqFg6_Pz.js";import{f as b}from"./date-DbclOb_I.js";import{m as D,a as y,b as S}from"./chunk-3BLMMOBU-DuMZ6Rqy.js";import{b as T}from"./useDialog-Bt8HOfNC.js";const _=30,A=1,h="lastDismissedReminderAt",g=90,L=60;function U(){const[o,l]=n.useState(!1),[c,k]=n.useState(null),[j,I]=n.useState(g),f=n.useRef(null),u=n.useRef(null),a=n.useRef(null),r=n.useCallback(()=>{I(g),clearTimeout(u.current),clearInterval(a.current),o&&(a.current=setInterval(()=>{I(e=>e<=1?(clearInterval(a.current),0):e-1)},1e3),u.current=setTimeout(()=>{N()},g*1e3))},[o]),N=()=>{l(!1),clearInterval(a.current),f.current=setTimeout(i,L*1e3)};n.useEffect(()=>{if(o){const e=["mousedown","mousemove","keypress","scroll","touchstart"];return e.forEach(s=>{window.addEventListener(s,r)}),r(),()=>{e.forEach(s=>{window.removeEventListener(s,r)}),clearTimeout(u.current),clearInterval(a.current)}}else clearInterval(a.current)},[o,r]);const R=()=>{const e=localStorage.getItem(h);return!e||Date.now()-Number(e)>=_*6e4},i=n.useCallback(async()=>{if(R())try{const{data:e}=await C.get("/overdue-guests",{params:{threshold:30}});if(!e.length){l(!1);return}const s=e.reduce((x,p)=>new Date(x.check_in_time)<new Date(p.check_in_time)?x:p),d=new Date(s.check_in_time),m=Math.floor((Date.now()-d)/36e5);k({guest:s.guest.name,checkInTime:d,hoursOverdue:m,logId:s.id}),l(!0)}catch(e){console.error("Failed to fetch overdue guests:",e)}},[]);n.useEffect(()=>{i();const e=setInterval(i,A*6e4);return()=>clearInterval(e)},[i]);const v=()=>{l(!1),localStorage.setItem(h,Date.now().toString()),clearTimeout(u.current),clearInterval(a.current),clearTimeout(f.current),f.current=setTimeout(i,_*6e4)},w=()=>{r(),c!=null&&c.logId&&O.post(route("guest.checkout",c.logId),{},{onSuccess:()=>{E({title:"Guest Checked Out",description:`${c.guest} has been successfully checked out.`,color:"success"}),l(!1),localStorage.removeItem(h),clearTimeout(u.current),clearInterval(a.current)},onError:e=>{var d,m;r();let s="An unexpected error occurred during checkout";e!=null&&e.errors?s=Object.values(e.errors)[0][0]:(m=(d=e==null?void 0:e.response)==null?void 0:d.data)!=null&&m.message?s=e.response.data.message:e!=null&&e.message?s=e.message:typeof e=="string"&&(s=e),E({title:"Checkout Failed",description:s,color:"danger"})}})};return t.jsx(D,{isOpen:o,onClose:v,placement:"center",backdrop:"blur",size:"xl",isDismissable:!1,children:t.jsx(y,{children:t.jsx(S,{className:"p-6",children:t.jsxs("div",{className:"text-center",children:[t.jsx("h3",{className:"text-lg font-bold mb-2",children:"Overdue Check‑out Reminder"}),c&&t.jsxs(t.Fragment,{children:[t.jsxs("p",{className:"mb-4",children:[t.jsx("strong",{children:c.guest})," has not checked out after ",t.jsxs("strong",{children:[c.hoursOverdue," hour(s)"]}),"."]}),t.jsxs("p",{children:["Checked in at: ",b(c.checkInTime)]})]}),t.jsxs("div",{className:"mt-4 text-sm text-gray-500",children:["Auto-closing in ",j," seconds..."]}),t.jsxs("div",{className:"mt-6 flex justify-center gap-3",children:[t.jsx(T,{color:"primary",onPress:w,children:"Check Out Now"}),t.jsx(T,{variant:"flat",onPress:v,children:"Remind Me Later"})]})]})})})})}export{U as A};
