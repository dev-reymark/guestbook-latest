import{r as n,W as L,j as e,Z as E,y as V}from"./app-Dm-DDIsi.js";import{f as M}from"./date-DbclOb_I.js";import{m as F,a as P,b as Y}from"./chunk-3BLMMOBU-5jXbwUGK.js";import{b as I}from"./useDialog-Ch3XXsI7.js";import{i as U}from"./chunk-6MDMHKHV-BuCN5vxH.js";const T=30,G=1,_="lastDismissedReminderAt",C=90,z=90,H="123";function B(){const[d,m]=n.useState(!1),[a,k]=n.useState(null),[y,b]=n.useState(C),[O,l]=n.useState(!1),[i,u]=n.useState(""),[x,p]=n.useState(!1),j=n.useRef(null),f=n.useRef(null),c=n.useRef(null),o=n.useCallback(()=>{b(C),clearTimeout(f.current),clearInterval(c.current),d&&(c.current=setInterval(()=>{b(s=>s<=1?(clearInterval(c.current),0):s-1)},1e3),f.current=setTimeout(()=>{S()},C*1e3))},[d]),S=()=>{m(!1),l(!1),u(""),clearInterval(c.current),j.current=setTimeout(h,z*1e3)};n.useEffect(()=>{if(d){const s=["mousedown","mousemove","keypress","scroll","touchstart"];return s.forEach(t=>{window.addEventListener(t,o)}),o(),()=>{s.forEach(t=>{window.removeEventListener(t,o)}),clearTimeout(f.current),clearInterval(c.current)}}else clearInterval(c.current)},[d,o]);const R=()=>{const s=localStorage.getItem(_);return!s||Date.now()-Number(s)>=T*6e4},h=n.useCallback(async()=>{if(R())try{const{data:s}=await L.get("/overdue-guests",{params:{threshold:30}});if(!s.length){m(!1);return}const t=s.reduce((g,N)=>new Date(g.check_in_time)<new Date(N.check_in_time)?g:N),r=new Date(t.check_in_time),v=Math.floor((Date.now()-r)/36e5);k({guest:t.guest.name,checkInTime:r,hoursOverdue:v,logId:t.id,guestId:t.guest.id_number,guest_id:t.guest_id}),m(!0),l(!1),u("")}catch(s){console.error("Failed to fetch overdue guests:",s)}},[]);n.useEffect(()=>{h();const s=setInterval(h,G*6e4);return()=>clearInterval(s)},[h]);const D=()=>{m(!1),l(!1),u(""),localStorage.setItem(_,Date.now().toString()),clearTimeout(f.current),clearInterval(c.current),clearTimeout(j.current),j.current=setTimeout(h,T*6e4)},w=()=>{o(),a!=null&&a.logId&&l(!0)},A=()=>{o();const s=i===a.guestId||i===a.guest_id.toString()||i===H;if(console.log("Verification code:",i,"is valid:",s),!s){E({title:"Verification Failed",description:"The verification code you entered is incorrect.",color:"danger"});return}p(!0),V.post(route("guest.checkout",a.logId),{},{onSuccess:()=>{E({title:"Guest Checked Out",description:`${a.guest} has been successfully checked out.`,color:"success"}),m(!1),l(!1),u(""),localStorage.removeItem(_),clearTimeout(f.current),clearInterval(c.current),p(!1)},onError:t=>{var v,g;o();let r="An unexpected error occurred during checkout";t!=null&&t.errors?r=Object.values(t.errors)[0][0]:(g=(v=t==null?void 0:t.response)==null?void 0:v.data)!=null&&g.message?r=t.response.data.message:t!=null&&t.message?r=t.message:typeof t=="string"&&(r=t),E({title:"Checkout Failed",description:r,color:"danger"}),p(!1)}})};return e.jsx(F,{isOpen:d,onClose:D,placement:"center",backdrop:"blur",size:"xl",isDismissable:!1,children:e.jsx(P,{children:e.jsx(Y,{className:"p-6",children:e.jsx("div",{className:"text-center",children:O?e.jsxs(e.Fragment,{children:[e.jsx("h3",{className:"text-lg font-bold mb-2",children:"Verify Checkout"}),e.jsxs("p",{className:"mb-4",children:["Please enter"," ",e.jsxs("strong",{children:[a.guest,"'s"]})," ","ID number to verify checkout."]}),e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx(U,{type:"text",placeholder:"Enter ID number",value:i,onChange:s=>u(s.target.value),className:"max-w-xs",autoFocus:!0}),e.jsxs("div",{className:"flex justify-center gap-3",children:[e.jsx(I,{color:"primary",onPress:A,isDisabled:!i||x,isLoading:x,children:x?"Please wait...":"Verify & Check Out"}),e.jsx(I,{variant:"flat",onPress:()=>{l(!1),u("")},isDisabled:x,children:"Cancel"})]})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("h3",{className:"text-lg font-bold mb-2",children:"Overdue Check‑out Reminder"}),a&&e.jsxs(e.Fragment,{children:[e.jsxs("p",{className:"mb-4",children:[e.jsx("strong",{children:a.guest})," ","has not checked out after ",e.jsxs("strong",{children:[a.hoursOverdue," ","hour(s)"]}),"."]}),e.jsxs("p",{children:["Checked in at: ",M(a.checkInTime)]})]}),e.jsxs("div",{className:"mt-4 text-sm text-danger-500",children:["Auto-closing in ",y," seconds..."]}),e.jsxs("div",{className:"mt-6 flex justify-center gap-3",children:[e.jsx(I,{color:"primary",onPress:w,children:"Check Out Now"}),e.jsx(I,{variant:"flat",onPress:D,children:"Remind Me Later"})]})]})})})})})}export{B as A};
