import{r as n,W as L,j as e,Z as E,y as V}from"./app-BOhBQsMj.js";import{f as M}from"./date-DbclOb_I.js";import{m as F,a as P,b as Y}from"./chunk-3BLMMOBU-BT8rryJw.js";import{b as I}from"./useDialog-DWl9359L.js";import{i as U}from"./chunk-6MDMHKHV-DVk9QeNE.js";const T=30,G=1,_="lastDismissedReminderAt",C=90,H=90,z="123";function B(){const[d,m]=n.useState(!1),[a,k]=n.useState(null),[O,b]=n.useState(C),[y,l]=n.useState(!1),[i,u]=n.useState(""),[v,p]=n.useState(!1),j=n.useRef(null),f=n.useRef(null),c=n.useRef(null),r=n.useCallback(()=>{b(C),clearTimeout(f.current),clearInterval(c.current),d&&(c.current=setInterval(()=>{b(s=>s<=1?(clearInterval(c.current),0):s-1)},1e3),f.current=setTimeout(()=>{S()},C*1e3))},[d]),S=()=>{m(!1),l(!1),u(""),clearInterval(c.current),j.current=setTimeout(h,H*1e3)};n.useEffect(()=>{if(d){const s=["mousedown","mousemove","keypress","scroll","touchstart"];return s.forEach(t=>{window.addEventListener(t,r)}),r(),()=>{s.forEach(t=>{window.removeEventListener(t,r)}),clearTimeout(f.current),clearInterval(c.current)}}else clearInterval(c.current)},[d,r]);const R=()=>{const s=localStorage.getItem(_);return!s||Date.now()-Number(s)>=T*6e4},h=n.useCallback(async()=>{if(R())try{const{data:s}=await L.get("/overdue-guests",{params:{threshold:30}});if(console.log("Overdue guests:",s),!s.length){m(!1);return}const t=s.reduce((x,N)=>new Date(x.check_in_time)<new Date(N.check_in_time)?x:N),o=new Date(t.check_in_time),g=Math.floor((Date.now()-o)/36e5);console.log("Most overdue guest:",t),console.log("Hours overdue:",g),k({guest:t.guest.name,checkInTime:o,hoursOverdue:g,logId:t.id,guestId:t.guest.id_number,guest_id:t.guest_id}),m(!0),l(!1),u("")}catch(s){console.error("Failed to fetch overdue guests:",s)}},[]);n.useEffect(()=>{h();const s=setInterval(h,G*6e4);return()=>clearInterval(s)},[h]);const D=()=>{m(!1),l(!1),u(""),localStorage.setItem(_,Date.now().toString()),clearTimeout(f.current),clearInterval(c.current),clearTimeout(j.current),j.current=setTimeout(h,T*6e4)},w=()=>{r(),a!=null&&a.logId&&l(!0)},A=()=>{r();const s=i===a.guestId||i===a.guest_id.toString()||i===z;if(console.log("Verification code:",i,"is valid:",s),!s){E({title:"Verification Failed",description:"The verification code you entered is incorrect.",color:"danger"});return}p(!0),V.post(route("guest.checkout",a.logId),{},{onSuccess:()=>{E({title:"Guest Checked Out",description:`${a.guest} has been successfully checked out.`,color:"success"}),m(!1),l(!1),u(""),localStorage.removeItem(_),clearTimeout(f.current),clearInterval(c.current),p(!1)},onError:t=>{var g,x;r();let o="An unexpected error occurred during checkout";t!=null&&t.errors?o=Object.values(t.errors)[0][0]:(x=(g=t==null?void 0:t.response)==null?void 0:g.data)!=null&&x.message?o=t.response.data.message:t!=null&&t.message?o=t.message:typeof t=="string"&&(o=t),E({title:"Checkout Failed",description:o,color:"danger"}),p(!1)}})};return e.jsx(F,{isOpen:d,onClose:D,placement:"center",backdrop:"blur",size:"xl",isDismissable:!1,children:e.jsx(P,{children:e.jsx(Y,{className:"p-6",children:e.jsx("div",{className:"text-center",children:y?e.jsxs(e.Fragment,{children:[e.jsx("h3",{className:"text-lg font-bold mb-2",children:"Verify Checkout"}),e.jsxs("p",{className:"mb-4",children:["Please enter"," ",e.jsxs("strong",{children:[a.guest,"'s"]})," ","ID number to verify checkout."]}),e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx(U,{type:"text",placeholder:"Enter ID number",value:i,onChange:s=>u(s.target.value),className:"max-w-xs",autoFocus:!0}),e.jsxs("div",{className:"flex justify-center gap-3",children:[e.jsx(I,{color:"primary",onPress:A,isDisabled:!i||v,isLoading:v,children:v?"Please wait...":"Verify & Check Out"}),e.jsx(I,{variant:"flat",onPress:()=>{l(!1),u("")},isDisabled:v,children:"Cancel"})]})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("h3",{className:"text-lg font-bold mb-2",children:"Overdue Check‑out Reminder"}),a&&e.jsxs(e.Fragment,{children:[e.jsxs("p",{className:"mb-4",children:[e.jsx("strong",{children:a.guest})," ","has not checked out after ",e.jsxs("strong",{children:[a.hoursOverdue," ","hour(s)"]}),"."]}),e.jsxs("p",{children:["Checked in at: ",M(a.checkInTime)]})]}),e.jsxs("div",{className:"mt-4 text-sm text-danger-500",children:["Auto-closing in ",O," seconds..."]}),e.jsxs("div",{className:"mt-6 flex justify-center gap-3",children:[e.jsx(I,{color:"primary",onPress:w,children:"Check Out Now"}),e.jsx(I,{variant:"flat",onPress:D,children:"Remind Me Later"})]})]})})})})})}export{B as A};
